#eval LOGDIR=/vagrant/log/iperf ; mkdir -p $LOGDIR

client0 0 iperf -s &>$LOGDIR/iperf_s.log & echo $! > /tmp/pid_iperf_server
server 0 truncate -s0 $LOGDIR/iperf_c.log

server 0 /vagrant/code/tc_helper.sh set_bw 300kbit
server 0 sudo rmmod tcp_probe ; sudo modprobe tcp_probe port=5001 full=1
server 2 sudo cat /proc/net/tcpprobe &>$LOGDIR/iperf_300kbit_cwnd.log & echo $! > /tmp/pid_tcpprobe_cat
server 2 sudo tcpdump -i eth1 -s0 -w $LOGDIR/iperf_300kbit.pcap 2>&1 & echo $! > /tmp/pid_tcpdump
server 2 /vagrant/code/tc_helper.sh watch_buffer_size &>$LOGDIR/iperf_300kbit_buffer.log & echo $! > /tmp/pid_buffersize
server 5 iperf -c client0 -t 300 >>$LOGDIR/iperf_c.log
server 327 sudo kill -SIGTERM $(cat /tmp/pid_tcpprobe_cat) & sudo kill -SIGTERM $(cat /tmp/pid_tcpdump) & sudo kill -SIGTERM $(cat /tmp/pid_buffersize)

server 330 /vagrant/code/tc_helper.sh set_bw 1mbit
server 330 sudo rmmod tcp_probe ; sudo modprobe tcp_probe port=5001 full=1
server 332 sudo cat /proc/net/tcpprobe &>$LOGDIR/iperf_1mbit_cwnd.log & echo $! > /tmp/pid_tcpprobe_cat
server 332 sudo tcpdump -i eth1 -s0 -w $LOGDIR/iperf_1mbit.pcap 2>&1 & echo $! > /tmp/pid_tcpdump
server 332 /vagrant/code/tc_helper.sh watch_buffer_size &>$LOGDIR/iperf_1mbit_buffer.log & echo $! > /tmp/pid_buffersize
server 335 iperf -c client0 -t 300 >>$LOGDIR/iperf_c.log
server 657 sudo kill -SIGTERM $(cat /tmp/pid_tcpprobe_cat) & sudo kill -SIGTERM $(cat /tmp/pid_tcpdump) & sudo kill -SIGTERM $(cat /tmp/pid_buffersize)

server 660 /vagrant/code/tc_helper.sh set_bw 5mbit
server 660 sudo rmmod tcp_probe ; sudo modprobe tcp_probe port=5001 full=1
server 662 sudo cat /proc/net/tcpprobe &>$LOGDIR/iperf_5mbit_cwnd.log & echo $! > /tmp/pid_tcpprobe_cat
server 662 sudo tcpdump -i eth1 -s0 -w $LOGDIR/iperf_5mbit.pcap 2>&1 & echo $! > /tmp/pid_tcpdump
server 662 /vagrant/code/tc_helper.sh watch_buffer_size &>$LOGDIR/iperf_5mbit_buffer.log & echo $! > /tmp/pid_buffersize
server 665 iperf -c client0 -t 120 >>$LOGDIR/iperf_c.log
server 797 sudo kill -SIGTERM $(cat /tmp/pid_tcpprobe_cat) & sudo kill -SIGTERM $(cat /tmp/pid_tcpdump) & sudo kill -SIGTERM $(cat /tmp/pid_buffersize)

server 800 /vagrant/code/tc_helper.sh set_bw 10mbit
server 800 sudo rmmod tcp_probe ; sudo modprobe tcp_probe port=5001 full=1
server 802 sudo cat /proc/net/tcpprobe &>$LOGDIR/iperf_10mbit_cwnd.log & echo $! > /tmp/pid_tcpprobe_cat
server 802 sudo tcpdump -i eth1 -s0 -w $LOGDIR/iperf_10mbit.pcap 2>&1 & echo $! > /tmp/pid_tcpdump
server 802 /vagrant/code/tc_helper.sh watch_buffer_size &>$LOGDIR/iperf_10mbit_buffer.log & echo $! > /tmp/pid_buffersize
server 805 iperf -c client0 -t 60 >>$LOGDIR/iperf_c.log
server 877 sudo kill -SIGTERM $(cat /tmp/pid_tcpprobe_cat) & sudo kill -SIGTERM $(cat /tmp/pid_tcpdump) & sudo kill -SIGTERM $(cat /tmp/pid_buffersize)

server 880 /vagrant/code/tc_helper.sh destroy
client0 880 kill -SIGTERM $(cat /tmp/pid_iperf_server)

